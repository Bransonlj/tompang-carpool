name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'carpool-service/**'
      - 'chat-service/**'
      - 'geospatial-service/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'carpool-service/**'
      - 'chat-service/**'
      - 'geospatial-service/**'

jobs:
  # Job for Spring Boot services
  test-spring-boot:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.modified, 'carpool-service/') || 
      contains(github.event.head_commit.modified, 'chat-service/') || 
      contains(github.event.head_commit.modified, 'geospatial-service/') 
      
    strategy:
      matrix:
        service:
          - carpool-service
          - chat-service
          - geospatial-service

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('${{ matrix.service }}/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build and Test Spring Boot service
      run: |
        cd ${{ matrix.service }}
        ./mvnw clean verify  

    # - name: Upload Test Results
    #   if: success() || failure()
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: test-results-${{ matrix.service }}
    #     path: ${{ matrix.service }}/target/test-logs/

  # # Job for NestJS/Node.js services
  # test-nestjs:
  #   runs-on: ubuntu-latest
  #   if: |
  #     contains(github.event.head_commit.modified, 'service2/') ||
  #     contains(github.event.head_commit.modified, 'service4/')

  #   strategy:
  #     matrix:
  #       service:
  #         - service2
  #         - service4

  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v3

  #   - name: Set up Node.js 16
  #     uses: actions/setup-node@v3
  #     with:
  #       node-version: '16'

  #   - name: Install dependencies
  #     run: |
  #       cd ${{ matrix.service }}
  #       npm install

  #   - name: Run Tests (NestJS)
  #     run: |
  #       cd ${{ matrix.service }}
  #       npm run test -- --watch=false --no-progress --browsers=ChromeHeadless

  #   - name: Upload Test Results
  #     if: success() || failure()
  #     uses: actions/upload-artifact@v3
  #     with:
  #       name: test-results-${{ matrix.service }}
  #       path: ${{ matrix.service }}/test-results/
